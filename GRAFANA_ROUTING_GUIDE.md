# Grafana Routing Configuration Guide

## Overview

Grafana can be configured to work with your reverse proxy (Traefik or Nginx) in two ways:
1. **Path-based routing**: Accessible at `https://test.projectdot.work/grafana`
2. **Domain-based routing**: Accessible at `https://test-monitoring.projectdot.work`

## Configuration Options

### Path-Based Routing (Default)

Access Grafana under a subpath on your main domain.

**Configuration:**
```yaml
grafana_routing_mode: "path"
grafana_path: "/grafana"
grafana_base_domain: "test.projectdot.work"  # Your main domain
grafana_enable_reverse_proxy: true
```

**Result:**
- Grafana accessible at: `https://test.projectdot.work/grafana`
- Grafana is automatically configured with `GF_SERVER_SERVE_FROM_SUB_PATH=true`
- Path prefix is stripped by Traefik before forwarding to Grafana

### Domain-Based Routing

Access Grafana on its own dedicated domain.

**Configuration:**
```yaml
grafana_routing_mode: "domain"
grafana_domain: "test-monitoring.projectdot.work"
grafana_enable_reverse_proxy: true
```

**Result:**
- Grafana accessible at: `https://test-monitoring.projectdot.work`
- Grafana configured for root path serving
- Domain must be in DNS pointing to your server

## Reverse Proxy Compatibility

### Traefik Configuration

**Path-based with Traefik:**
- Automatically uses `stripPrefix` middleware
- Adds router labels to Docker container
- Integrates with Traefik's certificate resolver

**Domain-based with Traefik:**
- Uses `Host()` routing rule
- Automatic SSL certificate via Let's Encrypt
- Applies configured middlewares (e.g., `internal-whitelist`)

### Nginx Configuration (Future)

When using Nginx:
- Path-based: Nginx location block with `proxy_pass` and path rewriting
- Domain-based: Separate server block for the domain
- Configuration templates will be generated by the Nginx role

## Example Inventory Configurations

### Example 1: Path-Based on Main Domain

```yaml
# In inventory.yml
grafana_routing_mode: "path"
grafana_path: "/grafana"
grafana_base_domain: "test.projectdot.work"
grafana_enable_reverse_proxy: true
reverse_proxy: "traefik"
traefik_domain: "test.projectdot.work"
```

### Example 2: Domain-Based with Separate Domain

```yaml
# In inventory.yml
grafana_routing_mode: "domain"
grafana_domain: "test-monitoring.projectdot.work"
grafana_enable_reverse_proxy: true
reverse_proxy: "traefik"
traefik_domain: "test.projectdot.work"
```

## Grafana Environment Variables

The role automatically configures Grafana environment variables:

**Path-based:**
```yaml
GF_SERVER_ROOT_URL: "https://test.projectdot.work/grafana/"
GF_SERVER_SERVE_FROM_SUB_PATH: "true"
```

**Domain-based:**
```yaml
GF_SERVER_ROOT_URL: "https://test-monitoring.projectdot.work/"
GF_SERVER_SERVE_FROM_SUB_PATH: "false"
```

## Important Notes

1. **Subpath must end with `/`**: Grafana's `ROOT_URL` must end with a trailing slash
2. **Path-based routing**: Grafana handles the full path (no prefix stripping needed) - works with both domain and IP
3. **Domain routing limitation**: Domain-based routing ONLY works with domain names. IP access will cause API call failures because `ROOT_URL` doesn't match the IP in Host header
4. **Network connectivity**: Grafana must be on the same Docker network as your reverse proxy
5. **Port exposure**: When using reverse proxy, Grafana ports are NOT exposed to the host
6. **Recommendation**: Use path-based routing if you need IP/VPN access

## Troubleshooting

### Grafana shows 404 on subpath
- Check `GF_SERVER_ROOT_URL` ends with `/`
- Verify `GF_SERVER_SERVE_FROM_SUB_PATH=true` for path-based routing
- Check Traefik router and middleware configuration

### Domain routing not working
- Verify DNS points `grafana_domain` to your server
- Check Traefik logs: `docker logs traefik`
- Verify certificate was issued for the domain
- **Important**: Domain routing ONLY works with domain names. IP access (e.g., `http://10.0.0.1`) will NOT work with domain routing - use path-based routing instead.

### IP Access with Domain Routing
- **Domain routing does NOT support IP access** - Grafana's `ROOT_URL` is domain-specific and API calls will fail when accessing via IP
- If you need IP/VPN access, use **path-based routing** instead
- Path-based routing works with both domain (`https://domain.com/grafana`) and IP (`http://10.0.0.1/grafana`)

### Reverse proxy not connecting
- Verify Grafana container is on the reverse proxy network
- Check container labels are correct
- Verify Grafana is listening on port 3000 inside container

