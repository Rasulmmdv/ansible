# Common middlewares configuration
http:
  middlewares:
    # Compression middleware
    gzip-compress:
      compress: {}

    # Security headers
    secure-headers:
      headers:
        accessControlAllowMethods:
          - GET
          - OPTIONS
          - PUT
          - POST
          - DELETE
          - PATCH
        accessControlMaxAge: 100
        hostsProxyHeaders:
          - "X-Forwarded-Host"
        frameDeny: true
        contentTypeNosniff: true
        browserXssFilter: true
        referrerPolicy: "same-origin"
        customRequestHeaders:
          X-Forwarded-Proto: "https"
{% if traefik_hsts_enabled %}
        stsSeconds: 31536000
        stsIncludeSubdomains: true
        stsPreload: true
{% endif %}

    # CORS middleware
    cors-headers:
      headers:
        accessControlAllowOriginList:
          - "*"
        accessControlAllowMethods:
          - GET
          - OPTIONS
          - PUT
          - POST
          - DELETE
          - PATCH
        accessControlAllowHeaders:
          - "*"
        accessControlExposeHeaders:
          - "*"
        accessControlMaxAge: 100
        addVaryHeader: true

    # IP whitelist for internal networks (VPN/Tailscale/WireGuard/local)
    internal-whitelist:
      ipAllowList:
        sourceRange:
          - "10.0.0.0/8"      # WireGuard and private networks (10.0.0.0/24 is included)
          - "100.64.0.0/10"   # Tailscale network
          - "172.16.0.0/12"   # Docker and private networks
          - "192.168.0.0/16"   # Private networks
          - "127.0.0.1/32"     # Localhost

    # Middleware for redirecting HTTP to HTTPS
    https-redirect:
      redirectScheme:
        scheme: https
        port: "443"
        permanent: true

    # Rewrite middleware for API - converts /traefik/api to /api
    traefik-api-rewrite:
      replacePathRegex:
        regex: "^/traefik/api(.*)$"
        replacement: "/api$1"

    # Redirect middleware - redirects /traefik to /traefik/
    traefik-add-slash:
      redirectRegex:
        regex: "^/traefik$"
        replacement: "/traefik/"
        permanent: true

    # Rewrite middleware for dashboard - converts /traefik to /dashboard/ and /traefik/... to /dashboard/...
    # Uses two separate regex replacements to handle both cases
    traefik-dashboard-rewrite-root:
      replacePathRegex:
        regex: "^/traefik$"
        replacement: "/dashboard/"

    traefik-dashboard-rewrite-path:
      replacePathRegex:
        regex: "^/traefik(/.*)$"
        replacement: "/dashboard$1"

    # Chain middleware to try root first, then path
    traefik-dashboard-rewrite:
      chain:
        middlewares:
          - "traefik-dashboard-rewrite-root"
          - "traefik-dashboard-rewrite-path"

    # Rewrite middleware for assets - converts /assets to /dashboard/assets
    traefik-assets-rewrite:
      replacePathRegex:
        regex: "^/assets(.*)$"
        replacement: "/dashboard/assets$1"

    # Rewrite middleware for dashboard resources (providers, icons, logos, etc.)
    traefik-resources-rewrite:
      replacePathRegex:
        regex: "^(/providers|/icons|/app-logo-128x128\\.png)(.*)$"
        replacement: "/dashboard$1$2"

{% if traefik_dashboard_auth_enabled and traefik_password_bcrypt is defined and traefik_password_bcrypt.stdout is defined %}
    # Basic auth middleware for Traefik dashboard
    traefik-auth:
      basicAuth:
        users:
          - "{{ traefik_dashboard_username }}:{{ traefik_password_bcrypt.stdout }}"
{% endif %}
