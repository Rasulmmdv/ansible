# Traefik dynamic configuration
# Simple configuration: dashboard at /traefik path, internal access only
http:
  routers:
    # Router for Traefik API at /traefik/api path
    traefik-api:
      entryPoints:
        - "web"
        - "websecure"
      rule: "PathPrefix(`/traefik/api`)"
      service: "api@internal"
      middlewares:
        - "traefik-api-rewrite@file"  # Rewrites /traefik/api to /api
        - "internal-whitelist@file"  # Internal network whitelist
      priority: 100

    # Router for direct /api access (dashboard makes requests to /api/...)
    traefik-api-direct:
      entryPoints:
        - "web"
        - "websecure"
      rule: "PathPrefix(`/api`) && !PathPrefix(`/traefik/api`)"  # Match /api but not /traefik/api
      service: "api@internal"
      middlewares:
        - "internal-whitelist@file"  # Internal network whitelist
      priority: 100

    # Router for dashboard assets at /assets path (dashboard may request assets from root)
    traefik-assets:
      entryPoints:
        - "web"
        - "websecure"
      rule: "PathPrefix(`/assets`)"  # Match /assets/...
      service: "api@internal"
      middlewares:
        - "traefik-assets-rewrite@file"  # Rewrites /assets to /dashboard/assets
        - "internal-whitelist@file"  # Internal network whitelist
      priority: 100

    # Router for dashboard resources (icons, providers, etc.)
    traefik-resources:
      entryPoints:
        - "web"
        - "websecure"
      rule: "PathPrefix(`/providers`) || PathPrefix(`/icons`) || Path(`/app-logo-128x128.png`)"  # Match various dashboard resources
      service: "api@internal"
      middlewares:
        - "traefik-resources-rewrite@file"  # Rewrites to /dashboard/...
        - "internal-whitelist@file"  # Internal network whitelist
      priority: 100

    # Router for Traefik dashboard at /traefik path (handles both /traefik and /traefik/)
    # This matches /traefik and all paths under it (except /traefik/api)
    traefik-dashboard:
      entryPoints:
        - "web"
        - "websecure"
      rule: "PathPrefix(`/traefik`) && !PathPrefix(`/traefik/api`)"  # Match /traefik and /traefik/... but not /traefik/api
      service: "api@internal"
      middlewares:
        - "traefik-dashboard-rewrite@file"  # Rewrites /traefik to /dashboard/ and /traefik/... to /dashboard/...
        - "internal-whitelist@file"  # Internal network whitelist
{% if traefik_dashboard_auth_enabled and traefik_password_bcrypt is defined and traefik_password_bcrypt.stdout is defined %}
        - "traefik-auth@file"  # Basic auth protection
{% endif %}
      priority: 100

    # Router to catch all HTTP traffic and redirect to HTTPS (but exclude /traefik, /api, /assets, and resource paths)
    web-redirect:
      entryPoints:
        - "web"
      rule: "HostRegexp(`{host:.+}`) && !PathPrefix(`/.well-known/acme-challenge`) && !PathPrefix(`/traefik`) && !PathPrefix(`/api`) && !PathPrefix(`/assets`) && !PathPrefix(`/providers`) && !PathPrefix(`/icons`) && !Path(`/app-logo-128x128.png`)"
      middlewares:
        - "https-redirect@file"
      service: "noop@internal"
      priority: 1

  services:
    # Noop service for redirect
    noop:
      loadBalancer:
        servers:
          - url: "http://127.0.0.1:1"

