---
# Prometheus scrape configuration for remote nginx exporters
# This configuration uses file-based service discovery
# Generated by remote_monitoring role

- job_name: 'remote_nginx_exporter'
  file_sd_configs:
    - files:
        - '{{ prometheus_config_dir }}/targets/*_nginx.yml'
      refresh_interval: 30s
  scrape_interval: {{ remote_monitoring_scrape_interval | default("15s") }}
  scrape_timeout: 10s
  metrics_path: /metrics
  honor_labels: true
  
  # Relabeling rules for better metric organization
  relabel_configs:
    - source_labels: [__meta_filepath]
      target_label: __tmp_filepath
    - source_labels: [__meta_filepath]
      regex: '.*/([^/]+)_nginx\.yml'
      target_label: instance
      replacement: '${1}'
    - source_labels: [__address__]
      target_label: __tmp_address
    - source_labels: [__tmp_address]
      regex: '([^:]+):(\d+)'
      target_label: __tmp_host
      replacement: '${1}'
    - source_labels: [__tmp_address]
      regex: '([^:]+):(\d+)'
      target_label: __tmp_port
      replacement: '${2}'
    - source_labels: [__tmp_host]
      target_label: instance
      replacement: '${1}'
    - source_labels: [__tmp_port]
      target_label: __metrics_path__
      replacement: '/metrics'
    - source_labels: [__tmp_filepath]
      action: keep
      regex: '.*_nginx\.yml$' 