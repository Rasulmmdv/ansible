---
# Playbook: restic.yml
# Description: Deploy Restic Backup Solution for Yandex Cloud S3 Storage
# Usage: 
#   From ansible/ directory: ansible-playbook playbooks/restic.yml -e "target_hosts=personal"
#   From root directory: ANSIBLE_CONFIG=ansible/ansible.cfg ansible-playbook -i ansible/all ansible/playbooks/restic.yml -e "target_hosts=personal"

- name: Deploy Restic Backup Solution for Yandex Cloud S3 Storage
  hosts: "{{ target_hosts | default('all') }}"
  become: yes
  vars:
    project_name: "kimdev"  # Set a default project name for paths
    # REQUIRED for S3: Set your S3 credentials
    # restic_aws_access_key_id: ""
    # restic_aws_secret_access_key: ""

    # Optional: Notification settings
    # restic_notification_email: ""
    # restic_notification_webhook: ""

    # If using a local repository, set this:
    # restic_repository_path: "/backup/restic-repo"
    
    # Basic configuration
    restic_instance_name: backup
    
    # REQUIRED: Set your Restic repository password
    # restic_password: "supersecret"
    
    # Yandex Cloud S3 repository configuration
    # Using Yandex Cloud Object Storage in ru-central1 region
    # Bucket name dynamically set based on hostname: {{ project_name }}-backups-{{ inventory_hostname }}
    restic_repository: "s3:https://storage.yandexcloud.net/backupsdi"
    restic_repository_type: "s3"
    restic_password: ""
    
    # Yandex Cloud S3 credentials
    # Get these from your Yandex Cloud IAM service account
    restic_aws_access_key_id: ""
    restic_aws_secret_access_key: ""
    restic_aws_region: "ru-central1"
    restic_aws_endpoint: "storage.yandexcloud.net"
    
    # Yandex Cloud S3 configuration
    restic_s3_endpoint_url: "storage.yandexcloud.net"
    restic_setup_selectel_ca: false

    # Backup paths (customize for your environment)
    restic_backup_paths:
      - "/data"
      - "/opt"
      - "/etc"
      - "/home"
      - "/root"
    
    # Exclusion patterns (files/directories to skip)
    restic_exclude_patterns:
      - "*.tmp"
      - "*.log"
      - "*.cache"
      - "/tmp/*"
      - "/var/tmp/*"
      - "/var/cache/*"
      - "node_modules"
      - ".git"
      - "/proc/*"
      - "/sys/*"
      - "/dev/*"
      - "/run/*"
      - "/var/run/*"
      # Exclude sensitive system files
      - "/etc/shadow*"
      - "/etc/gshadow*"
      - "/etc/ssh/*_key"
      - "/etc/ssl/private/*"
      - "/etc/wireguard/*"
      - "/etc/credstore*"
      - "/etc/sudoers*"
      - "/etc/polkit-1/rules.d/*"
      # Exclude Docker/container sensitive data
      - "*/docker_config/*"
      - "*/tls/*"
      - "*/certs/*"
      - "/opt/containerd/*"
    
    # Retention policy (adjust based on your storage costs and requirements)
    restic_keep_last: 7      # Keep last 7 snapshots
    restic_keep_daily: 14    # Keep daily snapshots for 14 days
    restic_keep_weekly: 8    # Keep weekly snapshots for 8 weeks
    restic_keep_monthly: 6   # Keep monthly snapshots for 6 months
    restic_keep_yearly: 3    # Keep yearly snapshots for 3 years
    
    # Schedule (systemd calendar format)
    restic_backup_schedule: "*-*-* 03:00:00"  # Daily at 3 AM
    restic_prune_schedule: "Sun *-*-* 04:00:00"   # Weekly on Sunday at 4 AM
    restic_check_schedule: "Sun *-*-* 05:00:00"   # Weekly on Sunday at 5 AM
    
    # Security and verification
    restic_verify_backups: true
    restic_encryption_enabled: true
    
    # Logging
    restic_log_level: "info"
    
    # PostgreSQL backup configuration
    restic_postgresql_backup_enabled: true
    restic_postgresql_retention_days: 7
    restic_postgresql_instances:
      - host: "localhost"
        is_container: false
        username: "" #TODO: add credentials
        password: "" #TODO: add credentials
        port: 5432
        databases: ["all"]

  roles:
    - restic 
