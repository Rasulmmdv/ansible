# Traefik dynamic configuration
# Priority system: Higher numbers = higher priority
# 100+ = High priority (dashboard, API, redirects)
# 50-99 = Medium priority (service-specific routers)
# 1-49 = Low priority (catch-all, fallbacks)
http:
  # Routers
  routers:
    # Router for Traefik dashboard
    dashboard:
      entryPoints:
        - "traefik"
      rule: "Host(`{{ traefik_dashboard_domain | default('localhost') }}`) && PathPrefix(`/`)"
      service: "api@internal"
      middlewares:
        - "vpn-whitelist@file"  # Tailscale-compatible whitelist
      priority: 100 # High priority for dashboard, but specific to dashboard domain

    # Router for Traefik API endpoints and health check
    api:
      entryPoints:
        - "traefik"
      rule: "PathPrefix(`/api`) || Path(`/ping`)"
      service: "api@internal"
      middlewares:
        - "vpn-whitelist@file"  # Tailscale-compatible whitelist
      priority: 100 # High priority for API access

    # Router to catch all HTTP traffic and redirect to HTTPS
    web-redirect:
      entryPoints:
        - "web"
      rule: "HostRegexp(`{host:.+}`) && !PathPrefix(`/.well-known/acme-challenge`)"
      middlewares:
        - "https-redirect@file"
      service: "noop@internal" # A dummy service, as it's just a redirect
      priority: 1 # Low priority to not interfere with other routers

{% if traefik_domain != "localhost" %}
    # Router to redirect www to non-www
    www-redirect:
      entryPoints:
        - "websecure"
      rule: "Host(`www.{{ traefik_domain }}`)"
      middlewares:
        - "www-redirect@file"
      service: "noop@internal"
      priority: 100 # High priority to catch www requests first
      tls: true
{% endif %}

  # Services
  services:
    # Noop service for redirect
    noop:
      loadBalancer:
        servers:
          - url: "http://127.0.0.1:1"

{% if traefik_rate_limit_enabled %}
  # Middlewares
  middlewares:
    # Rate limiting middleware
    rate-limit:
      rateLimit:
        average: {{ traefik_rate_limit_average }}
        burst: {{ traefik_rate_limit_burst }}
{% endif %}

{% if traefik_certificate_type == 'custom' and traefik_certificates_enabled %}
# TLS Configuration for Custom Certificates
tls:
  certificates:
{% for cert in traefik_certificate_files_container %}
    - certFile: "{{ cert.cert }}"
      keyFile: "{{ cert.key }}"
{% if cert.stores is defined %}
      stores:
{% for store in cert.stores %}
        - "{{ store }}"
{% endfor %}
{% endif %}
{% endfor %}
{% endif %}