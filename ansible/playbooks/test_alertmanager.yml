---
- name: Test Alertmanager Deployment
  hosts: all
  become: true
  
  tasks:
    - name: Check Alertmanager container status
      command: docker ps --filter "name=alertmanager" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
      register: alertmanager_status
      changed_when: false

    - name: Display Alertmanager status
      debug:
        var: alertmanager_status.stdout_lines

    - name: Check Alertmanager configuration
      uri:
        url: http://localhost:9093/api/v1/status
        method: GET
      register: alertmanager_api_status
      ignore_errors: true

    - name: Display Alertmanager API status
      debug:
        var: alertmanager_api_status

    - name: Check Prometheus Alertmanager integration
      uri:
        url: http://localhost:9090/api/v1/alertmanagers
        method: GET
      register: prometheus_alertmanager_status
      ignore_errors: true

    - name: Display Prometheus Alertmanager status
      debug:
        var: prometheus_alertmanager_status

    - name: Check alert rules
      command: docker exec prometheus promtool check rules /etc/prometheus/rules/sample_alerts.yml
      register: alert_rules_check
      ignore_errors: true

    - name: Display alert rules check
      debug:
        var: alert_rules_check.stdout_lines 