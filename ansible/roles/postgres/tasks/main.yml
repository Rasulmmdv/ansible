---
# Validate required variables for PostgreSQL
- name: Validate PostgreSQL configuration variables
  include_tasks: "{{ role_path }}/../common/tasks/variable_validation.yml"
  vars:
    role_name: "postgres"
    required_variables:
      - "postgres_password"
      - "postgres_db"
      - "project_name"
      - "postgres_instance_name"
    sensitive_variables:
      - "postgres_password"
    custom_validations:
      - name: "postgres_port"
        validation: "postgres_port | int > 0 and postgres_port | int <= 65535"
        error_message: "postgres_port must be a valid port number (1-65535)"
      - name: "postgres_password"
        validation: "postgres_password | length >= 8"
        error_message: "postgres_password must be at least 8 characters long for security"
      - name: "postgres_data_dir"
        validation: "postgres_data_dir | regex_search('^/')"
        error_message: "postgres_data_dir must be an absolute path starting with '/'"

- name: Setup PostgreSQL
  block:
    - name: Create postgresql data directory
      file:
        path: "{{ postgres_data_dir }}"
        state: directory
        owner: "{{ postgres_user_id }}"
        group: "{{ postgres_group_id }}"
        mode: "0755"
        recurse: true

    - name: Create postgresql log directory
      file:
        path: "{{ postgres_log_dir }}"
        state: directory
        owner: "{{ postgres_user_id }}"
        group: "{{ postgres_group_id }}"
        mode: "0775"
        recurse: true

    - name: Create postgresql config directory
      file:
        path: "{{ postgres_config_dir }}"
        state: directory
        mode: '0755'

- name: Template docker-compose for postgresql
  template:
    src: docker-compose.yml.j2
    dest: "{{ postgres_config_dir }}/docker-compose.yml"
    mode: '0644'

- name: Start postgresql service
  community.docker.docker_compose_v2:
    project_src: "{{ postgres_config_dir }}"
  when: not ansible_check_mode