---
# defaults file for loki

loki_image: "grafana/loki:3.5.3"
loki_container_name: "loki"
loki_data_dir: "/opt/monitoring/loki"
loki_user: "loki"
loki_group: "loki"
loki_user_id: 10001   # Official Loki Docker image UID
loki_group_id: 10001
loki_system_packages:
  - docker-compose
loki_ensure_docker_installed: true
loki_ports:
  - "3100:3100"
loki_volumes:
  - "{{ loki_data_dir }}/loki-config.yaml:/etc/loki/local-config.yaml:ro"
  - "{{ loki_data_dir }}:/loki"
  - "{{ loki_data_dir }}/compactor:/loki/compactor"
  - "{{ loki_data_dir }}/delete-requests:/loki/delete-requests"
loki_command:
  - '-config.file=/etc/loki/local-config.yaml'
  - '-config.expand-env=true'
  - '-log.level=info'

# Data retention configuration
loki_retention:
  # Time-based retention (30 days maximum)
  time: "{{ (alloy_log_retention_days | default(30)) * 24 }}h"  # Convert days to hours
  enabled: true
  table_manager:
    retention_period: "{{ (alloy_log_retention_days | default(30)) * 24 }}h"  # Convert days to hours

# Compactor configuration for retention management
loki_compactor:
  enabled: true
  working_directory: "{{ loki_data_dir }}/compactor"

# Ingestion rate limits configuration
loki_ingestion_rate_limit:
  enabled: true
  # Rate limit in bytes per second (default: 4MB/sec = 4194304 bytes/sec)
  # Setting to 8MB/sec to handle higher log volumes
  rate: "{{ loki_ingestion_rate_mb_per_sec | default(8) * 1024 * 1024 }}"
  burst: "{{ loki_ingestion_burst_mb | default(16) * 1024 * 1024 }}"


# Per-user rate limits
loki_per_user_rate_limit:
  enabled: true
  rate: "{{ loki_per_user_rate_mb_per_sec | default(4) * 1024 * 1024 }}"
  burst: "{{ loki_per_user_burst_mb | default(8) * 1024 * 1024 }}" 
# Ingester configuration
loki_ingester:
  max_chunk_age: "1h"
  chunk_target_size: 1048576  # 1MB
  chunk_retain_period: "30s"
  min_ready_duration: "15s"  # Controls the "waiting for 15s" behavior
  num_tokens: 512
  heartbeat_period: "5s"
  observe_period: "10s"
  join_after: "0s"

# Health check configuration
loki_health_check:
  max_retries: 30
  retry_delay: 5  # Reduced from hardcoded 10 seconds
  timeout: 300    # Total timeout in seconds (5 minutes) 
