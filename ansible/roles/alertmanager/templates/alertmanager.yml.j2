global:
{% if alertmanager_email_smtp and alertmanager_email_from %}
  smtp_smarthost: "{{ alertmanager_email_smtp }}"
  smtp_from: "{{ alertmanager_email_from }}"
{% if alertmanager_email_auth_username and alertmanager_email_auth_password %}
  smtp_auth_username: "{{ alertmanager_email_auth_username }}"
  smtp_auth_password: "{{ alertmanager_email_auth_password }}"
{% endif %}
  smtp_require_tls: true
{% endif %}

route:
  group_by: {{ alertmanager_route_group_by | to_json }}
  group_wait: {{ alertmanager_route_group_wait }}
  group_interval: {{ alertmanager_route_group_interval }}
  repeat_interval: {{ alertmanager_route_repeat_interval }}
  receiver: 'default'
  routes:
{% if alertmanager_email_smtp and alertmanager_email_from %}
    - receiver: 'email'
      matchers:
        - severity =~ "{{ alertmanager_default_severity }}"
{% endif %}
{% if alertmanager_telegram_bot_token %}
    - receiver: 'telegram'
      matchers:
        - severity =~ "{{ alertmanager_critical_severity }}"
{% endif %}

receivers:
  - name: 'default'
{% if alertmanager_email_smtp and alertmanager_email_from %}
    email_configs:
      - to: "{{ alertmanager_email_to }}"
        send_resolved: true
{% endif %}

{% if alertmanager_telegram_bot_token %}
  - name: 'telegram'
    telegram_configs:
      - bot_token: "{{ alertmanager_telegram_bot_token }}"
        chat_id: {{ alertmanager_telegram_chat_id }}
        api_url: "{{ alertmanager_telegram_api_url }}"
        send_resolved: true
        parse_mode: "HTML"
        message: |-
          {% raw %}{{ $severity := "" }}{{ if gt (len .Alerts) 0 }}{{ $severity = (index .Alerts 0).Labels.severity }}{{ end }}{{ if eq .Status "firing" }}
          {{ if eq $severity "critical" }}ðŸ”´ <b>Alert: {{ if .CommonLabels.alertname }}{{ .CommonLabels.alertname }}{{ else if gt (len .Alerts) 0 }}{{ (index .Alerts 0).Labels.alertname }}{{ else }}Unknown Alert{{ end }}</b>
          {{ else if eq $severity "warning" }}ðŸŸ  <b>Alert: {{ if .CommonLabels.alertname }}{{ .CommonLabels.alertname }}{{ else if gt (len .Alerts) 0 }}{{ (index .Alerts 0).Labels.alertname }}{{ else }}Unknown Alert{{ end }}</b>
          {{ else }}âšª <b>Alert: {{ if .CommonLabels.alertname }}{{ .CommonLabels.alertname }}{{ else if gt (len .Alerts) 0 }}{{ (index .Alerts 0).Labels.alertname }}{{ else }}Unknown Alert{{ end }}</b>{{ end }}

          <b>Status:</b> ðŸ”¥ FIRING
          <b>Severity:</b> {{ if eq $severity "critical" }}ðŸ”´ <b>Critical</b>{{ else if eq $severity "warning" }}ðŸŸ  <b>Warning</b>{{ else }}âšª <b>Info</b>{{ end }}

          {{ range .Alerts }}
          {{ if .Labels.instance }}<b>Instance:</b> <code>{{ .Labels.instance }}</code>{{ end }}
          {{ if .Labels.namespace }}<b>Namespace:</b> <code>{{ .Labels.namespace }}</code>{{ end }}
          {{ if .Labels.container }}<b>Container:</b> <code>{{ .Labels.container }}</code>{{ end }}
          {{ if .Labels.pod }}<b>Pod:</b> <code>{{ .Labels.pod }}</code>{{ end }}
          {{ if .Labels.hostname }}<b>Hostname:</b> <code>{{ .Labels.hostname }}</code>{{ end }}
          <b>Summary:</b> {{ .Annotations.summary }}
          <b>Description:</b> {{ .Annotations.description }}
          {{ end }}
          {{ else if eq .Status "resolved" }}
          {{ if eq $severity "critical" }}ðŸŸ¢ <b>Alert: {{ if .CommonLabels.alertname }}{{ .CommonLabels.alertname }}{{ else if gt (len .Alerts) 0 }}{{ (index .Alerts 0).Labels.alertname }}{{ else }}Unknown Alert{{ end }}</b>
          {{ else if eq $severity "warning" }}ðŸŸ¢ <b>Alert: {{ if .CommonLabels.alertname }}{{ .CommonLabels.alertname }}{{ else if gt (len .Alerts) 0 }}{{ (index .Alerts 0).Labels.alertname }}{{ else }}Unknown Alert{{ end }}</b>
          {{ else }}âšª <b>Alert: {{ if .CommonLabels.alertname }}{{ .CommonLabels.alertname }}{{ else if gt (len .Alerts) 0 }}{{ (index .Alerts 0).Labels.alertname }}{{ else }}Unknown Alert{{ end }}</b>{{ end }}

          <b>Status:</b> âœ… RESOLVED
          <b>Severity:</b> {{ if eq $severity "critical" }}ðŸŸ¢ <b>Critical</b>{{ else if eq $severity "warning" }}ðŸŸ¢ <b>Warning</b>{{ else }}âšª <b>Info</b>{{ end }}

          {{ range .Alerts }}
          {{ if .Labels.instance }}<b>Instance:</b> <code>{{ .Labels.instance }}</code>{{ end }}
          {{ if .Labels.namespace }}<b>Namespace:</b> <code>{{ .Labels.namespace }}</code>{{ end }}
          {{ if .Labels.container }}<b>Container:</b> <code>{{ .Labels.container }}</code>{{ end }}
          {{ if .Labels.pod }}<b>Pod:</b> <code>{{ .Labels.pod }}</code>{{ end }}
          {{ if .Labels.hostname }}<b>Hostname:</b> <code>{{ .Labels.hostname }}</code>{{ end }}
          <b>Summary:</b> {{ .Annotations.summary }}
          <b>Description:</b> {{ .Annotations.description }}
          
          {{ end }}
          {{ end }}
          {{ if gt (len .Alerts) 1 }}<b>Grouped:</b> {{ len .Alerts }} alerts{{ end }}{% endraw %}
{% endif %}

{% if alertmanager_email_smtp and alertmanager_email_from %}
  - name: 'email'
    email_configs:
      - to: "{{ alertmanager_email_to }}"
        send_resolved: true
        headers:
          subject: "Alert: {% raw %}{{ $first := index .Alerts 0 }}{{ if .CommonLabels.alertname }}{{ .CommonLabels.alertname }}{{ else if $first.Labels.alertname }}{{ $first.Labels.alertname }}{{ else }}Unknown Alert{{ end }}{% endraw %}"
        html: |-
          {% raw %}{{ $first := index .Alerts 0 }}{% endraw %}
          <h2>Alert: {% raw %}{{ if .CommonLabels.alertname }}{{ .CommonLabels.alertname }}{{ else if $first.Labels.alertname }}{{ $first.Labels.alertname }}{{ else }}Unknown Alert{{ end }}{% endraw %}</h2>
          <p><strong>Status:</strong> {% raw %}{{ if .Status }}{{ .Status }}{{ else if $first.Status }}{{ $first.Status }}{{ else }}firing{{ end }}{% endraw %}</p>
          <p><strong>Severity:</strong> {% raw %}{{ if .CommonLabels.severity }}{{ .CommonLabels.severity }}{{ else if $first.Labels.severity }}{{ $first.Labels.severity }}{{ else }}unknown{{ end }}{% endraw %}</p>
          <p><strong>Hostname:</strong> {% raw %}{{ if .CommonLabels.hostname }}{{ .CommonLabels.hostname }}{{ else if $first.Labels.hostname }}{{ $first.Labels.hostname }}{{ else }}unknown{{ end }}{% endraw %}</p>
          {% raw %}{{ if or .CommonAnnotations.summary $first.Annotations.summary }}<p><strong>Summary:</strong> {{ if .CommonAnnotations.summary }}{{ .CommonAnnotations.summary }}{{ else }}{{ $first.Annotations.summary }}{{ end }}</p>{{ end }}{% endraw %}
          {% raw %}{{ if or .CommonAnnotations.description $first.Annotations.description }}<p><strong>Description:</strong> {{ if .CommonAnnotations.description }}{{ .CommonAnnotations.description }}{{ else }}{{ $first.Annotations.description }}{{ end }}</p>{{ end }}{% endraw %}
{% endif %}



inhibit_rules:
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname', 'instance'] 