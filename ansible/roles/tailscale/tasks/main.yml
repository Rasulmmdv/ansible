---
# Validate required variables for Tailscale
- name: Validate Tailscale configuration variables
  include_tasks: "{{ role_path }}/../common/tasks/variable_validation.yml"
  tags: [prereq, validate]
  vars:
    role_name: "tailscale"
    required_variables:
      - "tailscale_auth_key"
      - "tailscale_install_url"
    sensitive_variables:
      - "tailscale_auth_key"
    custom_validations:
      - name: "tailscale_auth_key"
        validation: "tailscale_auth_key | length > 10"
        error_message: "tailscale_auth_key must be a valid Tailscale auth key (generate one at https://login.tailscale.com/admin/settings/keys)"
      - name: "tailscale_install_url"
        validation: "tailscale_install_url | regex_search('^https://')"
        error_message: "tailscale_install_url must be a valid HTTPS URL"

- name: Setup Tailscale
  block:
    - name: Download Tailscale install script
      ansible.builtin.get_url:
        url: "{{ tailscale_install_url }}"
        dest: "{{ tailscale_install_script_path }}"
        mode: "0755"
        timeout: 60
      tags: [install, networking]

    - name: Install Tailscale
      ansible.builtin.command: "{{ tailscale_install_script_path }}"
      args:
        creates: "/usr/bin/tailscale"
      register: tailscale_install
      tags: [install, networking]

    - name: Clean up install script
      ansible.builtin.file:
        path: "{{ tailscale_install_script_path }}"
        state: absent
      tags: [install, networking]

    # # TUN/TAP kernel module and device setup
    # - name: Load TUN kernel module
    #   ansible.builtin.modprobe:
    #     name: tun
    #     state: present
    #   tags: [tailscale, configure]

    # - name: Ensure /dev/net directory exists
    #   ansible.builtin.file:
    #     path: /dev/net
    #     state: directory
    #     mode: "0755"
    #   tags: [tailscale, configure]

    # - name: Create /dev/net/tun device if it doesn't exist
    #   ansible.builtin.file:
    #     path: /dev/net/tun
    #     state: touch
    #     mode: "0666"
    #   tags: [tailscale, configure]

    # - name: Set proper permissions on /dev/net/tun
    #   ansible.builtin.file:
    #     path: /dev/net/tun
    #     mode: "0666"
    #     owner: root
    #     group: root
    #   tags: [tailscale, configure]

    - name: Start and enable Tailscale service
      ansible.builtin.systemd:
        name: "tailscaled"
        state: "{{ tailscale_service_state }}"
        enabled: "{{ tailscale_service_enabled }}"
        daemon_reload: true
      tags: [configure, networking]

    - name: Check current Tailscale status
      ansible.builtin.command: "tailscale status"
      register: tailscale_current_status
      changed_when: false
      failed_when: false
      tags: [validate, networking]

    - name: Wait for Tailscale to be ready (after authentication)
      ansible.builtin.wait_for:
        path: "/var/lib/tailscale/tailscaled.state"
        timeout: 30
      when:
        - tailscale_auth is defined
        - tailscale_auth is changed
      tags: [validate, networking]
  when: not ansible_check_mode

- name: Set default Tailscale status for check mode
  set_fact:
    tailscale_current_status:
      rc: 1
      stdout: "Not available in check mode"
  when: ansible_check_mode
  tags: [validate, networking]

- name: Debug - Show current Tailscale status
  ansible.builtin.debug:
    msg: |
      Current Tailscale status:
      {{ tailscale_current_status.stdout_lines | default(['Not available in check mode']) }}
      Return code: {{ tailscale_current_status.rc | default('Not available in check mode') }}
  tags: [validate, networking]

- name: Build complete Tailscale up command
  ansible.builtin.set_fact:
    tailscale_up_cmd: "tailscale up --authkey={{ tailscale_auth_key }} --accept-dns={{ tailscale_accept_dns | lower }} --accept-routes={{ tailscale_accept_routes | lower }}"
  when: 
    - tailscale_auth_key is defined and tailscale_auth_key != ""
    - tailscale_current_status.rc != 0 or "Logged out" in tailscale_current_status.stdout
  tags: [configure, networking]

- name: Build Tailscale up command without auth key (if already authenticated)
  ansible.builtin.set_fact:
    tailscale_up_cmd: "tailscale up --accept-dns={{ tailscale_accept_dns | lower }} --accept-routes={{ tailscale_accept_routes | lower }}"
  when: 
    - tailscale_current_status.rc == 0 and "Logged out" not in tailscale_current_status.stdout
  tags: [configure, networking]

- name: Add hostname to Tailscale up command
  ansible.builtin.set_fact:
    tailscale_up_cmd: "{{ tailscale_up_cmd }} --hostname={{ tailscale_hostname }}"
  when: tailscale_hostname is defined and tailscale_hostname != ""
  tags: [configure, networking]

- name: Add route advertisement to Tailscale up command
  ansible.builtin.set_fact:
    tailscale_up_cmd: "{{ tailscale_up_cmd }} --advertise-routes={{ tailscale_advertise_routes | join(',') }}"
  when: 
    - tailscale_enable_route_advertisement | default(false)
    - tailscale_advertise_routes | length > 0
  tags: [configure, networking]

- name: Add exit node advertisement to Tailscale up command
  ansible.builtin.set_fact:
    tailscale_up_cmd: "{{ tailscale_up_cmd }} --advertise-exit-node={{ tailscale_advertise_exit_node | lower }}"
  when: tailscale_advertise_exit_node | default(false)
  tags: [configure, networking]

- name: Debug - Show complete Tailscale up command
  ansible.builtin.debug:
    msg: |
      Complete Tailscale up command:
      {{ tailscale_up_cmd | default('Not available in check mode') }}
      
      Configuration:
      - Auth key: {{ tailscale_auth_key | default('NOT_SET') }}
      - Hostname: {{ tailscale_hostname | default('NOT_SET') }}
      - Accept DNS: {{ tailscale_accept_dns | default(true) }}
      - Accept routes: {{ tailscale_accept_routes | default(false) }}
      - Advertise routes: {{ tailscale_advertise_routes | default([]) }}
      - Advertise exit node: {{ tailscale_advertise_exit_node | default(false) }}
  when: tailscale_up_cmd is defined
  tags: [configure, networking]

# - name: Authenticate Tailscale with complete configuration
#   ansible.builtin.command: "{{ tailscale_up_cmd }}"
#   register: tailscale_auth
#   timeout: 60
#   when: tailscale_up_cmd is defined

# - name: Debug - Show Tailscale authentication result
#   ansible.builtin.debug:
#     msg: |
#       Tailscale authentication result:
#       - Command: {{ tailscale_auth.cmd | default('NOT_RUN') }}
#       - Return code: {{ tailscale_auth.rc | default('NOT_RUN') }}
#       - Changed: {{ tailscale_auth.changed | default(false) }}
#       - Stdout: {{ tailscale_auth.stdout | default('NOT_RUN') }}
#       - Stderr: {{ tailscale_auth.stderr | default('NOT_RUN') }}
#   when: 
#     - tailscale_up_cmd is defined
#     - tailscale_auth is defined

- name: Show Tailscale status
  ansible.builtin.command: "tailscale status"
  register: tailscale_status
  changed_when: false
  tags: [validate, networking]

- name: Debug - Show Tailscale status
  ansible.builtin.debug:
    msg: |
      Tailscale status:
      {{ tailscale_status.stdout_lines | default(['Not available in check mode']) }}
  when: tailscale_status is defined
  tags: [validate, networking] 