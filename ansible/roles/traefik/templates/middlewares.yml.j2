# Common middlewares configuration
http:
  middlewares:
    # Compression middleware
    gzip-compress:
      compress: {}

    # Security headers
    secure-headers:
      headers:
        accessControlAllowMethods:
          - GET
          - OPTIONS
          - PUT
          - POST
          - DELETE
          - PATCH
        accessControlMaxAge: 100
        hostsProxyHeaders:
          - "X-Forwarded-Host"
        frameDeny: true
        contentTypeNosniff: true
        browserXssFilter: true
        referrerPolicy: "same-origin"
        customRequestHeaders:
          X-Forwarded-Proto: "https"
{% if traefik_hsts_enabled %}
        stsSeconds: 31536000
        stsIncludeSubdomains: true
        stsPreload: true
{% endif %}

    # CORS middleware
    cors-headers:
      headers:
        accessControlAllowOriginList:
          - "*"
        accessControlAllowMethods:
          - GET
          - OPTIONS
          - PUT
          - POST
          - DELETE
          - PATCH
        accessControlAllowHeaders:
          - "*"
        accessControlExposeHeaders:
          - "*"
        accessControlMaxAge: 100
        addVaryHeader: true

    # IP whitelist for internal networks (VPN/Tailscale/WireGuard/local)
    internal-whitelist:
      ipAllowList:
        sourceRange:
{% for network in traefik_internal_networks %}
          - "{{ network }}"
{% endfor %}

    # Middleware for redirecting HTTP to HTTPS
    https-redirect:
      redirectScheme:
        scheme: https
        port: "443"
        permanent: true

    # Redirect middleware - redirects /traefik to /traefik/ (adds trailing slash)
    # We redirect to /traefik/ which will then be rewritten to /dashboard/ by the main router
    traefik-redirect-slash:
      redirectRegex:
        regex: "^/traefik$"
        replacement: "/traefik/"
        permanent: true

    # Rewrite middleware for dashboard - converts /traefik/... to /dashboard/...
    # Handles /traefik/ and all subpaths (with or without leading slash)
    traefik-dashboard-rewrite:
      replacePathRegex:
        regex: "^/traefik(.*)$"
        replacement: "/dashboard$1"

{% if traefik_dashboard_auth_enabled and traefik_password_bcrypt is defined and traefik_password_bcrypt.stdout is defined %}
    # Basic auth middleware for Traefik dashboard
    traefik-auth:
      basicAuth:
        users:
          - "{{ traefik_dashboard_username }}:{{ traefik_password_bcrypt.stdout }}"
{% endif %}

    # Strip prefix middleware for Grafana subpath routing (dynamic - configured per service)
    # This middleware is referenced by services that need path prefix stripping
    # The actual prefix is configured in the service labels
