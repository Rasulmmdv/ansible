# Traefik dynamic configuration
# Dashboard accessible at /traefik path, internal access only
http:
  routers:
    # Router for Traefik API (dashboard makes requests to /api/...)
    traefik-api:
      entryPoints:
        - "web"
        - "websecure"
      rule: "PathPrefix(`/api`)"  # Match /api and all API endpoints
      service: "api@internal"
      middlewares:
        - "internal-whitelist@file"  # Internal network whitelist
{% if traefik_ssl_enabled and traefik_certificate_type == 'acme' and traefik_acme_enabled %}
      tls:
        certResolver: "{{ traefik_ssl_certificate_resolver }}"
{% endif %}
      priority: 100

    # Router for exact /traefik path (no trailing slash) - redirects to /traefik/
    traefik-dashboard-redirect:
      entryPoints:
        - "web"
        - "websecure"
      rule: "Path(`/traefik`)"  # Exact match for /traefik
      middlewares:
        - "internal-whitelist@file"  # Apply whitelist
        - "traefik-redirect-slash@file"  # Redirects /traefik to /traefik/
      service: "noop@internal"  # Redirect happens in middleware before reaching service
{% if traefik_ssl_enabled and traefik_certificate_type == 'acme' and traefik_acme_enabled %}
      tls:
        certResolver: "{{ traefik_ssl_certificate_resolver }}"
{% endif %}
      priority: 200  # Higher priority to catch exact match

    # Router for Traefik dashboard at /traefik/ path
    # Handles /traefik/ and /traefik/... and rewrites to /dashboard/...
    traefik-dashboard:
      entryPoints:
        - "web"
        - "websecure"
      rule: "PathPrefix(`/traefik`) && !Path(`/traefik`)"  # Match /traefik/ and subpaths, but not exact /traefik
      service: "api@internal"
      middlewares:
        - "traefik-dashboard-rewrite@file"  # Rewrites /traefik/ → /dashboard/ and /traefik/... → /dashboard/...
        - "internal-whitelist@file"  # Internal network whitelist
{% if traefik_dashboard_auth_enabled and traefik_password_bcrypt is defined and traefik_password_bcrypt.stdout is defined %}
        - "traefik-auth@file"  # Basic auth protection
{% endif %}
{% if traefik_ssl_enabled and traefik_certificate_type == 'acme' and traefik_acme_enabled %}
      tls:
        certResolver: "{{ traefik_ssl_certificate_resolver }}"
{% endif %}
      priority: 100

    # Default router for domain root (helps with ACME certificate generation)
    # This router matches the domain to trigger certificate generation even if no specific service is configured
    domain-default:
      entryPoints:
        - "websecure"
      rule: "Host(`{{ traefik_domain }}`)"
{% if traefik_ssl_enabled and traefik_certificate_type == 'acme' and traefik_acme_enabled %}
      tls:
        certResolver: "{{ traefik_ssl_certificate_resolver }}"
{% endif %}
      service: "noop@internal"
      priority: 10

    # Router to catch all HTTP traffic and redirect to HTTPS (but exclude special paths)
    web-redirect:
      entryPoints:
        - "web"
      rule: "HostRegexp(`{host:.+}`) && !PathPrefix(`/.well-known/acme-challenge`) && !PathPrefix(`/traefik`) && !PathPrefix(`/api`) && !PathPrefix(`/grafana`)"
      middlewares:
        - "https-redirect@file"
      service: "noop@internal"
      priority: 1

  services:
    # Noop service for redirect
    noop:
      loadBalancer:
        servers:
          - url: "http://127.0.0.1:1"

