# handlers file for iptables
---

# Save iptables rules to persistent files
- name: Save iptables rules
  listen: "commit iptables rules"
  become: true
  shell: |
    mkdir -p /etc/iptables
    iptables-save > /etc/iptables/rules.v4
    ip6tables-save > /etc/iptables/rules.v6
  when: not ansible_check_mode and (iptables_persistent_save | default(false) | bool)

# Reload/restart netfilter-persistent to ensure rules applied and persisted (optional)
- name: Restart netfilter-persistent
  listen: "commit iptables rules"
  become: true
  systemd:
    name: netfilter-persistent
    state: restarted
  when: not ansible_check_mode and (iptables_persistent_save | default(false) | bool) and ansible_service_mgr is defined and ansible_service_mgr == "systemd"
  ignore_errors: true

# Optional: Restart Docker to recreate its iptables chains after firewall changes
- name: Debug Docker restart
  listen: "commit iptables rules"
  debug:
    msg: "iptables rules changed. Docker restart is enabled and Docker is installed. Restarting to recreate chains."
  when: docker_installed | bool and (iptables_restart_docker_on_change | default(false) | bool)

- name: Restart docker to recreate its chains
  listen: "commit iptables rules"
  become: true
  systemd:
    name: docker
    state: restarted
    daemon_reload: true
  when: not ansible_check_mode and docker_installed | bool and (iptables_restart_docker_on_change | default(false) | bool)
