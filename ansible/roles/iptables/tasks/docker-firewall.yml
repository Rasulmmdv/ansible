---
# Manage iptables DOCKER-USER chain for container ingress control

- name: Ensure DOCKER-USER chain exists (block/rescue)
  become: true
  block:
    - name: Probe DOCKER-USER chain
      ansible.builtin.command: iptables -L DOCKER-USER
      register: docker_user_check
      changed_when: false
      failed_when: false

    - name: Create DOCKER-USER chain if missing
      ansible.builtin.command: iptables -N DOCKER-USER
      when: docker_user_check.rc != 0
      notify: commit iptables rules
  rescue:
    - name: Force-create DOCKER-USER chain on failure
      ansible.builtin.command: iptables -N DOCKER-USER
      notify: commit iptables rules

- name: Flush DOCKER-USER chain
  become: true
  ansible.builtin.iptables:
    chain: DOCKER-USER
    flush: true
  notify: commit iptables rules

- name: Allow established and related container traffic
  become: true
  ansible.builtin.iptables:
    chain: DOCKER-USER
    ctstate: ESTABLISHED,RELATED
    jump: RETURN
    comment: Allow established and related connections to containers
  notify: commit iptables rules

- name: Allow whitelisted sources to access Docker containers
  become: true
  ansible.builtin.iptables:
    chain: DOCKER-USER
    source: "{{ allowed_source }}"
    jump: RETURN
    comment: "Allow whitelisted source {{ allowed_source }} to access containers"
  loop: "{{ (iptables_docker_allowed_sources | default([])) + (iptables_docker_allowed_sources_extra | default([])) }}"
  loop_control:
    loop_var: allowed_source
  notify: commit iptables rules

- name: Allow publicly exposed TCP ports for containers
  become: true
  ansible.builtin.iptables:
    chain: DOCKER-USER
    protocol: tcp
    destination_port: "{{ tcp_port }}"
    jump: RETURN
    comment: "Allow public access to container TCP port {{ tcp_port }}"
  loop: "{{ (iptables_docker_public_tcp_ports | default([])) + (iptables_docker_public_tcp_ports_extra | default([])) }}"
  loop_control:
    loop_var: tcp_port
  notify: commit iptables rules

- name: Allow DNS queries from containers (UDP 53)
  become: true
  ansible.builtin.iptables:
    chain: DOCKER-USER
    protocol: udp
    destination_port: 53
    jump: RETURN
    comment: "Allow DNS queries from containers"
  notify: commit iptables rules

- name: Block all other external traffic to containers
  become: true
  ansible.builtin.iptables:
    chain: DOCKER-USER
    jump: DROP
    comment: Block all other external traffic to containers at the end of the chain
  notify: commit iptables rules

- name: Get Docker network information
  become: true
  ansible.builtin.shell: |
    docker network ls --format "{{ '{{.Name}}' }}" | grep -v "^host$" | grep -v "^none$" | while read network; do
      subnet=$(docker network inspect "$network" --format '{{ "{{range .IPAM.Config}}{{.Subnet}}{{end}}" }}' 2>/dev/null || echo "")
      if [ ! -z "$subnet" ]; then
        echo "$network:$subnet"
      fi
    done
  register: docker_networks_info
  changed_when: false
  failed_when: false

- name: Debug Docker networks
  ansible.builtin.debug:
    msg: "Docker networks found: {{ docker_networks_info.stdout_lines }}"

- name: Enable NAT for Docker networks (since Docker iptables is disabled)
  become: true
  ansible.builtin.iptables:
    table: nat
    chain: POSTROUTING
    source: "{{ network_info.split(':')[1] }}"
    jump: MASQUERADE
    comment: "NAT for Docker network {{ network_info.split(':')[0] }}"
  loop: "{{ docker_networks_info.stdout_lines }}"
  when: docker_networks_info.stdout_lines | length > 0 and ':' in network_info
  loop_control:
    loop_var: network_info
  notify: commit iptables rules

- name: Allow Docker network traffic in FORWARD chain (outbound)
  become: true
  ansible.builtin.iptables:
    chain: FORWARD
    source: "{{ network_info.split(':')[1] }}"
    jump: ACCEPT
    comment: "Allow Docker network {{ network_info.split(':')[0] }} outbound traffic"
  loop: "{{ docker_networks_info.stdout_lines }}"
  when: docker_networks_info.stdout_lines | length > 0 and ':' in network_info
  loop_control:
    loop_var: network_info
  notify: commit iptables rules

- name: Allow return traffic to Docker networks
  become: true
  ansible.builtin.iptables:
    chain: FORWARD
    destination: "{{ network_info.split(':')[1] }}"
    ctstate: RELATED,ESTABLISHED
    jump: ACCEPT
    comment: "Allow return traffic to Docker network {{ network_info.split(':')[0] }}"
  loop: "{{ docker_networks_info.stdout_lines }}"
  when: docker_networks_info.stdout_lines | length > 0 and ':' in network_info
  loop_control:
    loop_var: network_info
  notify: commit iptables rules

- name: Save iptables rules after Docker chain updates
  ansible.builtin.meta: flush_handlers


