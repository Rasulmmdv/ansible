---
# PostgreSQL Exporter Container role tasks
# Exports PostgreSQL metrics to Prometheus for monitoring using Docker containers

# Validate required variables for PostgreSQL Exporter Container
- name: Validate PostgreSQL Exporter Container configuration variables
  include_tasks: "{{ role_path }}/../common/tasks/variable_validation.yml"
  vars:
    role_name: "pgexporter-container"
    required_variables:
      - "pgexporter_postgres_host"
      - "pgexporter_postgres_port"
      - "pgexporter_postgres_user"
      - "pgexporter_postgres_password"
      - "pgexporter_postgres_db"
    sensitive_variables:
      - "pgexporter_postgres_password"
    custom_validations:
      - name: "pgexporter_postgres_port"
        validation: "pgexporter_postgres_port | int > 0 and pgexporter_postgres_port | int <= 65535"
        error_message: "pgexporter_postgres_port must be a valid port number (1-65535)"
      - name: "pgexporter_host_port"
        validation: "pgexporter_host_port | int > 0 and pgexporter_host_port | int <= 65535"
        error_message: "pgexporter_host_port must be a valid port number (1-65535)"

# Ensure Docker is installed and running
- name: Ensure Docker is installed
  package:
    name: docker.io
    state: present
  become: true
  when: not ansible_check_mode
  tags: [install, docker]

- name: Ensure Docker service is running and enabled
  systemd:
    name: docker
    state: started
    enabled: true
  become: true
  when: not ansible_check_mode
  tags: [install, docker]

- name: Ensure current user is in docker group
  user:
    name: "{{ ansible_user }}"
    groups: docker
    append: true
  become: true
  when: not ansible_check_mode
  tags: [install, docker]

# Create directory for Docker Compose files
- name: Create postgres-exporter compose directory
  file:
    path: "{{ pgexporter_compose_dir }}"
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0755'
  become: true
  when: not ansible_check_mode
  tags: [install, configure]

# Create Docker Compose file
- name: Create postgres-exporter Docker Compose file
  template:
    src: docker-compose.yml.j2
    dest: "{{ pgexporter_compose_file }}"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0644'
  become: true
  when: not ansible_check_mode
  tags: [install, configure]

# Create monitoring network if it doesn't exist
- name: Create monitoring Docker network
  docker_network:
    name: "{{ pgexporter_container_network }}"
    driver: bridge
  become: true
  when: not ansible_check_mode
  tags: [install, configure, networking]

# Try to get monitoring network details
- name: Try to get monitoring network details
  command: docker network inspect {{ pgexporter_monitoring_network_name }}
  register: monitoring_network_inspect
  changed_when: false
  failed_when: false
  become: true
  when: pgexporter_service_discovery_enabled
  tags: [configure, monitoring]

- name: Set pgexporter host IP and subnet facts (if network exists)
  set_fact:
    pgexporter_host_ip: "{{ (monitoring_network_inspect.stdout | from_json)[0].IPAM.Config[0].Gateway }}"
    pgexporter_monitoring_subnet: "{{ (monitoring_network_inspect.stdout | from_json)[0].IPAM.Config[0].Subnet }}"
  when: pgexporter_service_discovery_enabled and monitoring_network_inspect.stdout is defined and (monitoring_network_inspect.stdout | length) > 2
  tags: [configure, monitoring]

- name: Set default monitoring subnet (fallback if Docker network not found)
  set_fact:
    pgexporter_host_ip: "{{ ansible_default_ipv4.address }}"
    pgexporter_monitoring_subnet: "{{ pgexporter_allowed_sources[0] | default('10.0.0.0/24') }}"
  when: pgexporter_service_discovery_enabled and (monitoring_network_inspect.stdout is undefined or (monitoring_network_inspect.stdout | length) <= 2)
  tags: [configure, monitoring]

# Create service discovery file for Prometheus (only on Prometheus host)
- name: Ensure Prometheus targets directory exists
  file:
    path: "{{ pgexporter_prometheus_config_dir }}/targets"
    state: directory
    owner: "{{ pgexporter_prometheus_user_id }}"
    group: "{{ pgexporter_prometheus_group_id }}"
    mode: '0755'
  become: true
  when: pgexporter_service_discovery_enabled and pgexporter_generate_prometheus_targets and not ansible_check_mode
  tags: [configure, monitoring]

- name: Create postgres_exporter targets service discovery file
  template:
    src: postgres_exporter_targets.yml.j2
    dest: "{{ pgexporter_prometheus_config_dir }}/targets/postgres_exporter.yml"
    owner: "{{ pgexporter_prometheus_user_id }}"
    group: "{{ pgexporter_prometheus_group_id }}"
    mode: '0644'
  become: true
  when: pgexporter_service_discovery_enabled and pgexporter_generate_prometheus_targets and not ansible_check_mode
  tags: [configure, monitoring]

# Firewall rules: allow from monitoring subnet if known
- name: Allow monitoring subnet to reach postgres_exporter (INPUT)
  iptables:
    action: insert
    chain: INPUT
    protocol: tcp
    destination_port: "{{ pgexporter_host_port }}"
    source: "{{ pgexporter_monitoring_subnet }}"
    jump: ACCEPT
    comment: "Allow monitoring subnet to reach postgres_exporter container."
  become: true
  when: pgexporter_manage_firewall and pgexporter_monitoring_subnet is defined and not ansible_check_mode
  tags: [configure, monitoring]

# Firewall rules: allow explicit allowed sources
- name: Allow explicit sources to reach postgres_exporter (INPUT)
  iptables:
    action: insert
    chain: INPUT
    protocol: tcp
    destination_port: "{{ pgexporter_host_port }}"
    source: "{{ item }}"
    jump: ACCEPT
    comment: "Allow explicit source to reach postgres_exporter container."
  loop: "{{ pgexporter_allowed_sources }}"
  loop_control:
    label: "{{ item }}"
  become: true
  when: pgexporter_manage_firewall and pgexporter_allowed_sources | length > 0 and not ansible_check_mode
  tags: [configure, monitoring]

# Deploy and start the container
- name: Deploy postgres-exporter container
  docker_compose:
    project_src: "{{ pgexporter_compose_dir }}"
    state: present
  become: true
  when: not ansible_check_mode
  tags: [install, configure, monitoring]

# Health check for container deployment
- name: Verify postgres-exporter container is running
  docker_container_info:
    name: "{{ pgexporter_container_name }}"
  register: container_info
  become: true
  when: not ansible_check_mode
  tags: [configure, monitoring]

- name: Validate postgres-exporter container is running
  assert:
    that: container_info.exists and container_info.container.State.Running
    fail_msg: "PostgreSQL Exporter container is not running"
  when: container_info.exists is defined and not ansible_check_mode
  tags: [configure, monitoring]

# Test connectivity to postgres_exporter
- name: Test postgres_exporter HTTP endpoint
  uri:
    url: "http://localhost:{{ pgexporter_host_port }}/metrics"
    method: GET
    status_code: 200
  register: exporter_response
  failed_when: false
  when: not ansible_check_mode
  tags: [configure, monitoring]

- name: Validate postgres_exporter metrics endpoint
  assert:
    that: exporter_response.status == 200
    fail_msg: "PostgreSQL Exporter metrics endpoint is not accessible on port {{ pgexporter_host_port }}"
  when: exporter_response.status is defined and not ansible_check_mode
  tags: [configure, monitoring]

